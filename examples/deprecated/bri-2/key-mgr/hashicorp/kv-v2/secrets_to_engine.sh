#!/bin/bash

TOKEN_PATH=${TOKEN_PATH}/.root
retries=10
while [ ! -f ${TOKEN_PATH} ]; do
  if [ "$retries" == 0 ]; then
    echo "ERROR: Timeout while waiting for the file ${TOKEN_PATH}"
    exit 1
  fi
  sleep 1
  ((retries--))
done

VAULT_TOKEN=$(cat ${TOKEN_PATH})
KEY_PATH=/privkey.json
SECRETS=(56202652FDFFD802B7252A456DBD8F3ECC0352BBDE76C23B40AFE8AEBD714E2E 5FBB50BFF6DFAD35C4A374C9237BA2F7EAED9C6868E0108CB259B62D68029B1A 86B021CCB810F26A30445B85F71E4C1596A11A97DDF9B9E348AC93D1DA6735BC DD614C3B343E1B6DBD1B2811D4F146CC90337DEEF96AB97C353578E871B19D5E 425D92F63A836F890F1690B34B6A25C2971EF8D035CD8EA8592FD1069BD151C6 C4B172E72033581BC41C36FA0448FCF031E9A31C4A3E300E541802DFB7248307 706CC0876DA4D52B6DCE6F5A0FF210AEFCD51DE9F9CFE7D1BF7B385C82A06B8C 1476C66DE79A57E8AB4CADCECCBE858C99E5EDF3BFFEA5404B15322B5421E18C A2426FE76ECA2AA7852B95A2CE9CC5CC2BC6C05BB98FDA267F2849A7130CF50D 41B9C5E497CFE6A1C641EFCA314FF84D22036D1480AF5EC54558A5EDD2FEAC03)
ADDRESSES=(0x7E654d251Da770A068413677967F6d3Ea2FeA9E4 0xdbb881a51CD4023E4400CEF3ef73046743f08da3 0x6009608A02a7A15fd6689D6DaD560C44E9ab61Ff 0xfF778b716FC07D98839f48DdB88D8bE583BEB684 0xffbBa394DEf3Ff1df0941c6429887107f58d4e9b 0x664895b5fE3ddf049d2Fb508cfA03923859763C6 0xf5956Eb46b377Ae41b41BDa94e6270208d8202bb 0x93f7274c9059e601be4512F656B57b830e019E41 0xbfc7137876d7Ac275019d70434B0f0779824a969 0xA8d8DB1d8919665a18212374d623fc7C0dFDa410)
TENANTS=(_ _ _ _ _ _ bar foo foo bar)
SECRET_PATH="default/"

echo "ROOT_TOKEN: ${VAULT_TOKEN}"
i=0
while [ $i -lt ${#SECRETS[*]} ]; do
  echo "Importing address ${ADDRESSES[$i]}..."
  echo '{"data": {"value": "'${SECRETS[$i]}'"}}' > $KEY_PATH
  curl --header "X-Vault-Token: ${VAULT_TOKEN}" \
    --request POST \
    --data @/${KEY_PATH} \
    "${VAULT_ADDR}/v1/secret/data/${SECRET_PATH}${TENANTS[$i]}${ADDRESSES[$i]}"
  i=$(( $i + 1));
done
